<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <title>54 Stories AR</title>
  <!-- A frame library -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <!-- ar.js library -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
</head>
  <!-- This is the body section that helps input the content -->
  <body style="margin:0; overflow:hidden;">
    <!-- The a-scene is the container that keeps all the 3D elements together -->
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      <!-- This is the webcam that allows the camera to work and ensure experience is complete -->
      <a-entity camera>
        <!-- This lets the user click the objects with a mouse or tap on mobile -->
        <a-entity cursor="fuse: false; rayOrigin: mouse" raycaster="objects: .clickable"></a-entity>  
      </a-entity>

      <!-- This small section is the model of Ponte -->
      <a-marker type="pattern" url="pattern4.patt"
                emitevents="true"
                smooth="true"
                smoothCount="10"
                smoothTolerance="0.01"
                smoothThreshold="5">

        <a-entity position="0 0 1" rotation="-90 0 0">
          <!-- The a entity section is where Ponte is inputed and I can scale it and move the positioning -->
          <a-entity 
            gltf-model="url(final_ponte.glb)" 
            scale="0.1 0.1 0.1" 
            position="0 0 0" 
            rotation="0 0 0">
          </a-entity>

          <!-- Spacing settings -->
          <!-- Base position for overlays -->
          <!-- Reduced spacing so all overlays fit building height -->
          <!-- Overlay spacing set equally for both stories -->

          <!-- Story 1 overlays -->
          <a-image id="story1_img" src="img/story_1_overlay.png" width="0.8" height="0.3" position="-0.9 1.2 0.2"></a-image>
          <a-image id="story1_about" src="img/story_1_about_overlay.png" width="0.8" height="0.3" position="-0.9 0.8 0.2" visible="false"></a-image>
          <a-image id="story1_fact" src="img/story_1_fact_overlay.png" width="0.8" height="0.3" position="-0.9 0.4 0.2" visible="false"></a-image>
          <a-box id="story1_button" class="clickable" color="red" depth="0.5" height="2" width="2" position="-1 1.9 1.0" material="opacity: 0; transparent: true"></a-box>

          <!-- Story 2 overlays -->
          <a-image id="story2_img" src="img/story_2_overlay.png" width="0.8" height="0.3" position="0.9 1.2 0.2"></a-image>
          <a-image id="story2_about" src="img/story_2_about_overlay.png" width="0.8" height="0.3" position="0.9 0.8 0.2" visible="false"></a-image>
          <a-image id="story2_fact" src="img/story_2_fact_overlay.png" width="0.8" height="0.3" position="0.9 0.4 0.2" visible="false"></a-image>
          <a-box id="story2_button" class="clickable" color="red" depth="0.5" height="2" width="2" position="1 1.9 1.0" material="opacity: 0; transparent: true"></a-box>

          <!-- Story 3 overlays -->
          <a-image id="story3_img" src="img/story_3_overlay.png" width="0.8" height="0.3" position="-0.9 1.2 0.2" visible="false"></a-image>
          <a-image id="story3_about" src="img/story_3_about_overlay.png" width="0.8" height="0.3" position="-0.9 0.8 0.2" visible="false"></a-image>
          <a-image id="story3_fact" src="img/story_3_fact_overlay.png" width="0.8" height="0.3" position="-0.9 0.4 0.2" visible="false"></a-image>
          <a-box id="story3_button" class="clickable" color="red" depth="0.5" height="2" width="2" position="-1 1.9 1.0" material="opacity: 0; transparent: true" visible="false"></a-box>

          <!-- Story 4 overlays -->
          <a-image id="story4_img" src="img/story_4_overlay.png" width="0.8" height="0.3" position="0.9 1.2 0.2" visible="false"></a-image>
          <a-image id="story4_about" src="img/story_4_about_overlay.png" width="0.8" height="0.3" position="0.9 0.8 0.2" visible="false"></a-image>
          <a-image id="story4_fact" src="img/story_4_fact_overlay.png" width="0.8" height="0.3" position="0.9 0.4 0.2" visible="false"></a-image>
          <a-box id="story4_button" class="clickable" color="red" depth="0.5" height="2" width="2" position="1 1.9 1.0" material="opacity: 0; transparent: true" visible="false"></a-box>

          <!-- Navigation buttons for turning pages, which will allow the user to go to the next story -->
          <a-image id="next_button" src="img/next_button.png" width="0.4" height="0.15" position="0.9 0.1 0.2" visible="true"></a-image>
          <a-box id="next_button_box" class="clickable" color="red" depth="0.05" height="0.2" width="0.45" position="0.9 0.1 0.25" material="opacity: 0; transparent: true" visible="true"></a-box>

          <a-image id="back_button" src="img/back_button.png" width="0.4" height="0.15" position="-0.9 0.1 0.2" visible="false"></a-image>
          <a-box id="back_button_box" class="clickable" color="red" depth="0.05" height="0.2" width="0.45" position="-0.9 0.1 0.25" material="opacity: 0; transparent: true" visible="false"></a-box>

        </a-entity>
      </a-marker>
    </a-scene>

    <!-- This is the audio section for when the user clicks on the story it, plays the voice recording of the story -->
    <audio id="story1_audio" src="audio/story_1.mp3"></audio>
    <audio id="story2_audio" src="audio/story_2.mp3"></audio>
    <audio id="story3_audio" src="audio/story_3.mp3"></audio>
    <audio id="story4_audio" src="audio/story_4.mp3"></audio>

    <!-- The place where all the animations and functionality take place -->

    <script>
      // This is where the slide down also known as drop downs appear
      function animateDropdown(image, targetY, delay = 0) {
        setTimeout(() => {
          image.setAttribute('visible', true); //When an image is visible which is true, it animates downwards
          image.setAttribute('animation', {
            property: 'position',
            to: `${image.getAttribute('position').x} ${targetY} ${image.getAttribute('position').z}`,
            dur: 500, //How fast the animation is
            easing: 'easeOutQuad' //The smoothness of the animation
          });
        }, delay); //The delay makes the animation smooth and not rough.
      }

      // This function reverses it, it slides up and hides
      function animateDown(image, targetY) {
        image.setAttribute('animation', {
          property: 'position',
          to: `${image.getAttribute('position').x} ${targetY} ${image.getAttribute('position').z}`,
          dur: 500, //How fast the animation is
          easing: 'easeInQuad'//The smoothness of the animation
        });
        setTimeout(() => image.setAttribute('visible', false), 500);
      }

      // This ensures that when a user clicks on story 1, it plays one audio at a time, not more than one
      function stopAllAudio() {
        document.querySelectorAll('audio').forEach(audio => {
          audio.pause();
          audio.currentTime = 0;
        });
      }

      let storyButtons = []; // track listeners

      //This is a reusable function, each of the toggles own panels 
      function setupStoryButton(buttonId, aboutId, factId, audioId = null) {
        const button = document.querySelector(buttonId);
        const about = document.querySelector(aboutId);
        const fact = document.querySelector(factId);
        const audio = audioId ? document.querySelector(audioId) : null; 

        //The funtion is showcasing the dropdwns of the about and fact images
        function toggleDropdown() {
          const isVisible = about.getAttribute('visible') === "true" || about.getAttribute('visible') === true;

          console.log('Button clicked:', buttonId);
          console.log('About:', about, 'Fact:', fact, 'Audio:', audio);

          //This is showing the about and fact image while playing the audio
          if (!isVisible) {
            animateDropdown(about, about.getAttribute('position').y, 0);
            animateDropdown(fact, fact.getAttribute('position').y, 300);
            if (audio) {
              stopAllAudio();
              audio.currentTime = 0;
              audio.play();
            }
          //This is hiding the about and fact image while playing the audio
          } else {
            animateDown(about, about.getAttribute('position').y);
            animateDown(fact, fact.getAttribute('position').y);
            if (audio) {
              audio.pause();
              audio.currentTime = 0;
            }
          }
        }

        // This is to saved for removing later
        storyButtons.push({ button, toggleDropdown });

        // Always listen for clicks, even if invisible at start
        button.addEventListener('click', toggleDropdown);
        button.addEventListener('touchstart', (e) => {
          e.preventDefault();
          toggleDropdown();
        });
      }

      // Function is to ensure the user can click and touch
      function clearStoryListeners() {
        storyButtons.forEach(({ button, toggleDropdown }) => {
          button.removeEventListener('click', toggleDropdown);
        });
        storyButtons = [];
      }

      // Navigation logic for turning pages (next and back)
      const nextButtonBox = document.querySelector('#next_button_box');
      const backButtonBox = document.querySelector('#back_button_box');
      const nextButton = document.querySelector('#next_button');
      const backButton = document.querySelector('#back_button');
      let currentPage = 1; //Handles the switching of story 1 and 2 (page 1) story 3 and 4 (page 2)

      function showStories(set) {
        stopAllAudio();
        clearStoryListeners(); // remove all old listeners first

        // Hide all dropdowns when switching pages
        ['#story1_about', '#story1_fact', '#story2_about', '#story2_fact',
        '#story3_about', '#story3_fact', '#story4_about', '#story4_fact']
        .forEach(id => document.querySelector(id).setAttribute('visible', false));

        if (set === 1) {
          ['#story1_img', '#story1_button', '#story2_img', '#story2_button']
            .forEach(id => document.querySelector(id).setAttribute('visible', true));
          ['#story3_img', '#story3_button', '#story4_img', '#story4_button']
            .forEach(id => document.querySelector(id).setAttribute('visible', false));
          
          // This is setting up all the buttons for Story 1, 2, 3, and 4
          setupStoryButton('#story1_button', '#story1_about', '#story1_fact', '#story1_audio');
          setupStoryButton('#story2_button', '#story2_about', '#story2_fact', '#story2_audio');

          // Similar function, hides the back button and shows next button
          nextButton.setAttribute('visible', true);
          nextButtonBox.setAttribute('visible', true);
          backButton.setAttribute('visible', false);
          backButtonBox.setAttribute('visible', false);      

        
        } else if (set === 2) {
          //Shows story 3 and 4
          ['#story3_img', '#story3_button', '#story4_img', '#story4_button']
            .forEach(id => document.querySelector(id).setAttribute('visible', true));
          //hides story 1 and 2
          ['#story1_img', '#story1_button', '#story2_img', '#story2_button']
            .forEach(id => document.querySelector(id).setAttribute('visible', false));

          //Functions for the story buttons
          setupStoryButton('#story3_button', '#story3_about', '#story3_fact', '#story3_audio');
          setupStoryButton('#story4_button', '#story4_about', '#story4_fact', '#story4_audio');
          
          //Now shows the back button and then hides the next button
          nextButton.setAttribute('visible', false);
          nextButtonBox.setAttribute('visible', false);
          backButton.setAttribute('visible', true);
          backButtonBox.setAttribute('visible', true);      
        }

        //The console log was used to help test and figure out what was not working
        // console.log('Active page:', set);
        // console.log('Story 1 visible?', document.querySelector('#story1_button').getAttribute('visible'));
        // console.log('Story 2 visible?', document.querySelector('#story2_button').getAttribute('visible'));
        // console.log('Story 3 visible?', document.querySelector('#story3_button').getAttribute('visible'));
        // console.log('Story 4 visible?', document.querySelector('#story4_button').getAttribute('visible'));
      }
      
      //The functions is to ensure starting on story 1 and 2
      showStories(1)

      // Next page when the next button is clicked
      nextButtonBox.addEventListener('click', () => {
        if (currentPage === 1) {
          currentPage = 2;
          showStories(2);
        }
      });

      // Back page when back button is clicked
      backButtonBox.addEventListener('click', () => {
        if (currentPage === 2) {
          currentPage = 1;
          showStories(1);
        }
      });
    </script>
  </body>
</html>
